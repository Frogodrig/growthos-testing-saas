RequirementID,Category,Title,Description,Status,PhaseID,CreatedAt,UpdatedAt
INTG-001,INTG,"Integrate Resend for transactional email","Replace the stub EmailAction in /packages/action-layer/src/actions/email.ts with a real Resend (resend.com) integration. Add resend npm package to action-layer dependencies. Use RESEND_API_KEY env var. Send real emails with to/subject/body from ActionRequest payload. Maintain tenant isolation by including tenantId in email metadata. Log every send attempt (success or failure) with timestamp. Return ActionResult with success status and messageId. Keep integration minimal — no templates, no batching, no retries in v1.",Done,PH-001,2026-02-13T08:35:00.000Z,2026-02-13T11:15:00.000Z
INTG-002,INTG,"Integrate Google Calendar API for meeting booking","Replace the stub CalendarAction in /packages/action-layer/src/actions/calendar.ts with real Google Calendar API integration. Add googleapis npm package. Use service account credentials via GOOGLE_CALENDAR_CREDENTIALS env var. Create real calendar events with leadId, scheduledAt, and duration from payload. Each tenant needs a calendarId config (store on Tenant model or env). Return ActionResult with success status and event link. Keep minimal — no recurring events, no attendee management in v1.",Done,PH-001,2026-02-13T08:35:00.000Z,2026-02-13T11:15:00.000Z
INTG-003,INTG,"Integrate Stripe Subscriptions for billing","Add Stripe billing integration. Add stripe npm package to action-layer dependencies. Use STRIPE_SECRET_KEY and STRIPE_WEBHOOK_SECRET env vars. Implement: create Stripe customer on tenant creation, create checkout session for subscription, handle subscription.created/updated/deleted webhook events to toggle tenant active status. Add stripeCustomerId and subscriptionStatus fields to Tenant Prisma model. This is the billing foundation — not a full action handler but a service consumed by the tenant activation layer (PH-002). Keep minimal — one plan per SaaS, no usage-based billing in v1.",Done,PH-001,2026-02-13T08:35:00.000Z,2026-02-13T11:15:00.000Z
INTG-004,INTG,"Replace stub webhook handler with real HTTP delivery","Replace the stub WebhookAction in /packages/action-layer/src/actions/webhook.ts with real HTTP webhook delivery. Use native fetch (Node 18+) to POST/PUT to the configured URL with the payload body. Include tenantId and timestamp in webhook headers. Return ActionResult with success/failure and HTTP status code. Log every delivery attempt. No retry logic in v1 — just fire and log.",Done,PH-001,2026-02-13T08:35:00.000Z,2026-02-13T11:15:00.000Z
INTG-005,INTG,"Add external action logging to AgentLog table","Ensure every external action (email send, calendar booking, webhook fire, Stripe call) is logged to the AgentLog table in Prisma with: tenantId, action type, payload summary, success/failure, duration, and timestamp. Modify the ActionLayer.execute() wrapper in /packages/action-layer/src/index.ts to log after each action completes. This provides an audit trail of all external interactions per tenant.",Done,PH-001,2026-02-13T08:35:00.000Z,2026-02-13T11:15:00.000Z
INTG-006,INTG,"Update env configuration for integration secrets","Add all new integration environment variables to infrastructure/env.example and .env: RESEND_API_KEY, GOOGLE_CALENDAR_CREDENTIALS, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_PRICE_ID_BOOKER, STRIPE_PRICE_ID_LEADQUALIFIER, STRIPE_PRICE_ID_FOLLOWUP. Document each variable with a comment. Ensure the 3 SaaS wrappers can access these via process.env.",Done,PH-001,2026-02-13T08:35:00.000Z,2026-02-13T11:15:00.000Z
INTG-007,INTG,"Update metrics endpoint with real integration data","Update /services/api-gateway/src/routes/metrics.ts to replace TODO stubs (mrr: 0, churn: 0) with real queries. Calculate MRR from active Stripe subscriptions. Calculate churn from cancelled subscriptions. Count actual emails sent, meetings booked, and webhooks fired from AgentLog records. Keep queries simple — direct Prisma counts, no aggregation pipelines.",Done,PH-001,2026-02-13T08:35:00.000Z,2026-02-13T11:15:00.000Z
ACTV-001,ACTV,"Create POST /api/tenant/create endpoint","Create a new route file /services/api-gateway/src/routes/tenant.ts with a POST /api/tenant/create endpoint. This is the production tenant creation flow (replaces /dev/bootstrap). Accept: name, email, password (optional for v1 — can default). Create Tenant in Prisma with plan='free' and subscriptionStatus='none'. Create a Stripe customer via createStripeCustomer() from action-layer and store stripeCustomerId on the Tenant. Create the admin User linked to the tenant. Generate and return a JWT token. Register this route in the api-gateway index.ts. This endpoint must NOT require auth (it's the signup flow). Keep minimal — no email verification, no password hashing in v1.",Done,PH-002,2026-02-13T11:20:00.000Z,2026-02-13T11:25:00.000Z
ACTV-002,ACTV,"Create POST /api/billing/checkout endpoint","Add a POST /api/billing/checkout endpoint to tenant.ts routes. This endpoint REQUIRES auth (tenant must exist and be logged in). Read the tenant's stripeCustomerId from Prisma. Determine the correct STRIPE_PRICE_ID based on which SaaS app is running (use SaaSConfig.slug to map: booker→STRIPE_PRICE_ID_BOOKER, leadqualifier→STRIPE_PRICE_ID_LEADQUALIFIER, followup→STRIPE_PRICE_ID_FOLLOWUP). Call createCheckoutSession() from action-layer with success/cancel URLs from request body. Return the checkout URL. Keep minimal — no plan selection UI, one plan per SaaS.",Done,PH-002,2026-02-13T11:20:00.000Z,2026-02-13T11:25:00.000Z
ACTV-003,ACTV,"Create Stripe webhook handler endpoint","Add a POST /api/stripe/webhook endpoint. This endpoint must NOT require auth — Stripe calls it directly. Accept raw body (configure Fastify to not parse JSON for this route). Use constructWebhookEvent() to validate the signature. Use parseSubscriptionEvent() to extract subscription data. On subscription created/updated: find tenant by stripeCustomerId and update subscriptionStatus. On subscription deleted: set subscriptionStatus to 'canceled'. Log all webhook events to console. Keep minimal — no retry handling, no idempotency checks in v1.",Done,PH-002,2026-02-13T11:20:00.000Z,2026-02-13T11:25:00.000Z
ACTV-004,ACTV,"Add subscription enforcement middleware","Add middleware to the api-gateway that checks tenant subscriptionStatus before allowing access to /api/* routes (except /api/tenant/create and /api/billing/checkout which must remain open). Read the tenant from Prisma using tenantId from JWT. If subscriptionStatus is 'none' or 'canceled' — return 403 with message 'Active subscription required'. Allow 'active' and 'trialing' statuses through. Skip enforcement entirely for /dev/* routes in non-production. Add this as a Fastify onRequest hook after auth middleware.",Done,PH-002,2026-02-13T11:20:00.000Z,2026-02-13T11:25:00.000Z
ACTV-005,ACTV,"Wire tenant routes into all 3 SaaS apps","Register the new tenant routes (tenant create, billing checkout, stripe webhook) in the api-gateway index.ts. Ensure the Stripe webhook route is excluded from both auth and subscription enforcement middleware. Pass SaaSConfig to the tenant route registration so it can determine the correct price ID. Verify all 3 SaaS wrappers (saas-booker, saas-leadqualifier, saas-followup) inherit these routes. Test the full flow: create tenant → checkout → webhook → access granted.",Done,PH-002,2026-02-13T11:20:00.000Z,2026-02-13T11:25:00.000Z
MACT-001,MACT,"Add PAYMENT_MODE environment flag","Add PAYMENT_MODE environment variable to infrastructure/env.example, .env, and .env.production. Allowed values: 'stripe' (default) and 'manual'. Add to all 3 Railway services. When not set, must default to 'stripe' so existing behavior is unchanged. Document the variable with a comment explaining its purpose. This is a configuration-only change — no logic modification.",Done,PH-004,2026-02-14T07:55:00.000Z,2026-02-14T09:30:00.000Z
MACT-002,MACT,"Modify subscription gate middleware for manual mode","Modify the subscription enforcement middleware in /services/api-gateway/src/index.ts. When PAYMENT_MODE=manual: allow 'active' and 'pending' through (pending = signed up but not yet manually activated, active = manually activated). When PAYMENT_MODE=stripe: keep existing behavior (allow 'active' and 'trialing'). The 'none' status should remain blocked in both modes in production. Also modify POST /api/tenant/create in /services/api-gateway/src/routes/tenant.ts: when PAYMENT_MODE=manual, set initial subscriptionStatus to 'pending' instead of 'none', and skip Stripe customer creation. Do NOT delete any existing Stripe logic — wrap it in if (process.env.PAYMENT_MODE !== 'manual') conditional. Do NOT modify database schema.",Done,PH-004,2026-02-14T07:55:00.000Z,2026-02-14T09:30:00.000Z
MACT-003,MACT,"Create POST /internal/activate-tenant admin endpoint","Create a new route POST /internal/activate-tenant in /services/api-gateway/src/routes/tenant.ts. This endpoint must ONLY be registered when PAYMENT_MODE=manual. Protected by ADMIN_SECRET header — request must include header X-Admin-Secret matching ADMIN_SECRET env var. Accepts JSON body { tenant_id: string }. Finds tenant by ID in Prisma, sets subscriptionStatus to 'active', logs activation event to console with timestamp and tenant_id. Returns { success: true, tenant_id, status: 'active' }. If tenant not found → 404. If secret missing/wrong → 401. This endpoint must be auth-exempt and subscription-exempt. Do NOT expose a tenant list. Do NOT log the admin secret value.",Done,PH-004,2026-02-14T07:55:00.000Z,2026-02-14T09:30:00.000Z
MACT-004,MACT,"Wrap Stripe webhook activation in PAYMENT_MODE conditional","Modify the POST /api/stripe/webhook handler in /services/api-gateway/src/routes/tenant.ts. Wrap the entire webhook handler body in if (process.env.PAYMENT_MODE !== 'manual'). When PAYMENT_MODE=manual: the endpoint should still exist but return { status: 'ignored', reason: 'manual activation mode' } without processing the webhook. Do NOT delete any Stripe code. Do NOT refactor the billing service. The conditional must be a simple wrapper around existing logic so removing it later restores full Stripe behavior.",Done,PH-004,2026-02-14T07:55:00.000Z,2026-02-14T09:30:00.000Z
MACT-005,MACT,"Update metrics and health responses for manual mode","Modify /services/api-gateway/src/routes/metrics.ts: when PAYMENT_MODE=manual, set activationMode to 'manual' in the response and label manually activated tenants as 'Manually Activated' instead of 'active'. Modify the /health endpoint response to include paymentMode field showing current PAYMENT_MODE value. This provides visibility into which mode the system is operating in. Do NOT redesign any UI. Only add conditional labels to existing JSON responses.",Done,PH-004,2026-02-14T07:55:00.000Z,2026-02-14T09:30:00.000Z
